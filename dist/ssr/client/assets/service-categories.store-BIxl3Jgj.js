import{s as H,r as h,h as c,aB as g,aA as l}from"./index-CXeQdQLH.js";import{u as z}from"./usePagination-CH_YJQGk.js";const R="2d7dd621-7a0c-4be8-ac04-46ec289dd34d",W=H("serviceCategories",()=>{const y=h([]),f=h(null),d=h([]),C=h(!1),T=h([]),S=h({total_count:0,max_level:0}),w=h(!1),i=c(()=>R),_=async(e,t)=>{if(!i.value)throw new Error("VITE_SITE_ID не определен.");try{let r,a={};e?r=e:(r=`/sites/${i.value}/service-categories/`,a=Object.entries(t||{}).reduce((v,[o,p])=>(p!==void 0&&(v[o]=p),v),{}));const{data:n}=await g.get(r,{params:e?{}:a});return y.value=n.results,n}catch(r){throw u(r,"Не удалось загрузить список категорий услуг."),r}},s=z(_,{defaultPageSize:10,defaultSortBy:"order",defaultDescending:!1});function u(e,t){console.error(t,e);let r=t;const a=e.response?.data;if(typeof a=="string"?r=a:a?.detail?r=a.detail:a?.message?r=a.message:e.message&&(r=e.message),a&&typeof a=="object"&&!a.detail&&!a.message){const n=Object.entries(a).map(([v,o])=>`${v}: ${Array.isArray(o)?o.join(", "):String(o)}`).join("; ");n&&(r=n)}l.create({type:"negative",message:r,timeout:5e3})}function $(e){if(e.length===0)return e;const t=new Map;e.forEach(a=>{const n=a.parent?.id||null;t.has(n)||t.set(n,[]),t.get(n).push(a)});function r(a){const n=t.get(a)||[],v=[];return n.sort((o,p)=>o.order!==p.order?o.order-p.order:o.name.localeCompare(p.name)),n.forEach(o=>{v.push(o),v.push(...r(o.id))}),v}return r(null)}async function I(){if(C.value&&d.value.length>0)return d.value;console.log("🔄 Загружаем все категории в кеш...");const e=[];try{s.clearFilters();let t=await _();for(e.push(...t.results);t.next;)t=await _(t.next),e.push(...t.results);const r=Array.from(new Map(e.map(a=>[a.id,a])).values());return d.value=r,C.value=!0,D(r),console.log(`✅ Все категории загружены в кеш: ${r.length}`),r}catch(t){throw console.error("Ошибка при загрузке всех категорий:",t),t}}function D(e){if(!e||e.length===0){S.value={total_count:0,max_level:0};return}const t=e.reduce((r,a)=>Math.max(r,a.level),0);S.value={total_count:e.length,max_level:t},console.log(`📊 Обновлена мета-информация: всего=${e.length}, макс_уровень=${t}`)}function E(e=""){return(C.value?d.value:y.value).filter(a=>{if(!e)return!0;const n=e.toLowerCase();return a.name.toLowerCase().includes(n)||a.brief&&a.brief.toLowerCase().includes(n)}).map(a=>({id:a.id,name:a.name,slug:a.slug,brief:a.brief,level:a.level,has_children:a.has_children,is_published:a.is_published,display_name:"—".repeat(a.level)+" "+a.name+(a.has_children?" 📁":"")+(a.is_published?"":" (скрыто)")}))}function m(){console.log("🗑️ Сбрасываем кеш..."),C.value=!1,d.value=[]}async function b(){if(!i.value)throw new Error("VITE_SITE_ID не определен.");w.value=!0;try{const{data:e}=await g.get(`/sites/${i.value}/service-categories/hierarchy/`);return T.value=e.categories,S.value=e.meta,e.categories}catch(e){throw u(e,"Не удалось загрузить иерархию категорий услуг."),e}finally{w.value=!1}}async function P(e){if(!i.value)return l.create({type:"negative",message:"VITE_SITE_ID не определен."}),null;try{const{data:t}=await g.get(`/sites/${i.value}/service-categories/${e}/`);return f.value=t,t}catch(t){return u(t,"Не удалось загрузить данные категории услуг."),f.value=null,null}}async function x(e){if(!i.value)return l.create({type:"negative",message:"VITE_SITE_ID не определен."}),null;try{const{data:t}=await g.post(`/sites/${i.value}/service-categories/`,e);return l.create({type:"positive",message:`Категория услуг "${t.name}" успешно создана.`}),m(),t}catch(t){return u(t,"Ошибка при создании категории услуг."),null}}async function A(e,t){if(!i.value)return l.create({type:"negative",message:"VITE_SITE_ID не определен."}),null;try{const{data:r}=await g.put(`/sites/${i.value}/service-categories/${e}/`,t);return l.create({type:"positive",message:`Категория услуг "${r.name}" успешно обновлена.`}),m(),f.value?.id===e&&await P(e),r}catch(r){return u(r,"Ошибка при обновлении категории услуг."),null}}async function V(e){if(!i.value)return l.create({type:"negative",message:"VITE_SITE_ID не определен."}),!1;try{return await g.delete(`/sites/${i.value}/service-categories/${e}/`),l.create({type:"positive",message:"Категория услуг успешно удалена."}),m(),f.value?.id===e&&(f.value=null),!0}catch(t){return u(t,"Ошибка при удалении категории услуг."),!1}}async function q(e){if(!i.value)return l.create({type:"negative",message:"VITE_SITE_ID не определен."}),!1;try{return await Promise.all(e.map(t=>g.delete(`/sites/${i.value}/service-categories/${t}/`))),l.create({type:"positive",message:`Успешно удалено ${e.length} категорий услуг.`}),m(),!0}catch(t){return u(t,"Ошибка при массовом удалении категорий услуг."),!1}}async function F(e){if(!i.value)throw new Error("VITE_SITE_ID не определен.");try{const{data:t}=await g.get(`/sites/${i.value}/service-categories/tree/`,{params:{search:e}});return t.results}catch(t){throw u(t,"Не удалось выполнить поиск категорий услуг."),t}}async function L(e){return s.setSearch(e),await s.fetchData()}async function j(e){return Object.entries(e).forEach(([t,r])=>{s.setFilter(t,r)}),await s.fetchData()}async function M(){return s.clearFilters(),await s.fetchData()}async function N(e){const t=await s.fetchData(e),r=$(t);return y.value=r,r}async function O(e){return await I(),E(e)}function B(){f.value=null}return{serviceCategories:y,selectedServiceCategory:f,hierarchyData:T,hierarchyMeta:S,hierarchyLoading:w,loading:s.loading,allCategoriesCache:c(()=>d.value),currentPage:c(()=>s.currentPage.value),pageSize:c(()=>s.pageSize.value),totalCount:c(()=>s.totalCount.value),totalPages:c(()=>s.totalPages.value),hasNext:c(()=>s.hasNext.value),hasPrevious:c(()=>s.hasPrevious.value),qTablePagination:s.qTablePagination,serviceCategoryOptions:c(()=>E()),fetchServiceCategories:N,fetchServiceCategoriesHierarchy:b,searchServiceCategoriesTree:F,fetchServiceCategoryById:P,createServiceCategory:x,updateServiceCategory:A,deleteServiceCategory:V,clearSelectedServiceCategory:B,searchServiceCategories:L,filterServiceCategories:j,clearFilters:M,bulkDeleteServiceCategories:q,searchCategoriesForAutocomplete:O,loadAllCategoriesIntoCache:I,invalidateCache:m,goToPage:s.goToPage,goToNextPage:s.goToNextPage,goToPreviousPage:s.goToPreviousPage,handleTableRequest:s.handleTableRequest}});export{W as u};
