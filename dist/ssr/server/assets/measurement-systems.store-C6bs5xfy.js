import{defineStore as b}from"pinia";import{ref as S,computed as f}from"vue";import{a as c}from"../server-entry.js";import{Notify as u}from"quasar";import{u as x}from"./usePagination-CZ7Hsnrr.js";const V="2d7dd621-7a0c-4be8-ac04-46ec289dd34d",O=b("measurementSystems",()=>{const i=S([]),o=S(null),n=f(()=>V),r=x(async(e,a)=>{if(!n.value)throw new Error("VITE_SITE_ID не определен.");try{let t,s={};e?t=e:(t=`/sites/${n.value}/measurement-systems/`,s=Object.entries(a||{}).reduce((v,[y,d])=>(d!==void 0&&(v[y]=d),v),{}));const{data:m}=await c.get(t,{params:e?{}:s});return i.value=m.results,m}catch(t){throw l(t,"Не удалось загрузить список систем измерений."),t}},{defaultPageSize:10,defaultSortBy:"name",defaultDescending:!1});function l(e,a){console.error(a,e);let t=a;const s=e.response?.data;if(typeof s=="string"?t=s:s?.detail?t=s.detail:s?.message?t=s.message:e.message&&(t=e.message),s&&typeof s=="object"&&!s.detail&&!s.message){const m=Object.entries(s).map(([v,y])=>`${v}: ${Array.isArray(y)?y.join(", "):String(y)}`).join("; ");m&&(t=m)}u.create({type:"negative",message:t,timeout:5e3})}async function g(e){return r.fetchData(e)}async function p(e){if(!n.value)return u.create({type:"negative",message:"VITE_SITE_ID не определен."}),null;try{const{data:a}=await c.get(`/sites/${n.value}/measurement-systems/${e}/`);return o.value=a,a}catch(a){return l(a,"Не удалось загрузить данные системы измерений."),o.value=null,null}}async function h(e){if(!n.value)return u.create({type:"negative",message:"VITE_SITE_ID не определен."}),null;try{const{data:a}=await c.post(`/sites/${n.value}/measurement-systems/`,e);return u.create({type:"positive",message:`Система измерений "${a.name}" успешно создана.`}),await g(),a}catch(a){return l(a,"Ошибка при создании системы измерений."),null}}async function T(e,a){if(!n.value)return u.create({type:"negative",message:"VITE_SITE_ID не определен."}),null;try{const{data:t}=await c.put(`/sites/${n.value}/measurement-systems/${e}/`,a);return u.create({type:"positive",message:`Система измерений "${t.name}" успешно обновлена.`}),await g(),o.value?.id===e&&await p(e),t}catch(t){return l(t,"Ошибка при обновлении системы измерений."),null}}async function I(e){if(!n.value)return u.create({type:"negative",message:"VITE_SITE_ID не определен."}),!1;try{return await c.delete(`/sites/${n.value}/measurement-systems/${e}/`),u.create({type:"positive",message:"Система измерений успешно удалена."}),await g(),o.value?.id===e&&(o.value=null),!0}catch(a){return l(a,"Ошибка при удалении системы измерений."),!1}}function E(){o.value=null}async function P(e,a){if(!n.value)return u.create({type:"negative",message:"VITE_SITE_ID не определен."}),!1;try{await c.patch(`/sites/${n.value}/measurement-systems/${e}/`,{is_base_system:a});const t=i.value.findIndex(s=>s.id===e);return t!==-1&&i.value[t]&&(i.value[t].is_base_system=a),!0}catch(t){return l(t,"Ошибка при изменении статуса базовой системы."),!1}}async function $(e){if(!n.value)return u.create({type:"negative",message:"VITE_SITE_ID не определен."}),!1;try{return await Promise.all(e.map(a=>c.delete(`/sites/${n.value}/measurement-systems/${a}/`))),u.create({type:"positive",message:`Успешно удалено ${e.length} систем измерений.`}),await g(),!0}catch(a){return l(a,"Ошибка при массовом удалении систем измерений."),!1}}async function w(e,a){if(!n.value)return u.create({type:"negative",message:"VITE_SITE_ID не определен."}),!1;try{return await Promise.all(e.map(t=>c.patch(`/sites/${n.value}/measurement-systems/${t}/`,{is_base_system:a}))),e.forEach(t=>{const s=i.value.findIndex(m=>m.id===t);s!==-1&&i.value[s]&&(i.value[s].is_base_system=a)}),u.create({type:"positive",message:`Успешно обновлено ${e.length} систем измерений.`}),!0}catch(t){return l(t,"Ошибка при массовом обновлении статуса базовой системы."),!1}}async function _(e){return r.setSearch(e),await r.fetchData()}async function D(e){return Object.entries(e).forEach(([a,t])=>{r.setFilter(a,t)}),await r.fetchData()}async function M(){return r.clearFilters(),await r.fetchData()}return{measurementSystems:i,selectedMeasurementSystem:o,loading:r.loading,currentPage:f(()=>r.currentPage.value),pageSize:f(()=>r.pageSize.value),totalCount:f(()=>r.totalCount.value),totalPages:f(()=>r.totalPages.value),hasNext:f(()=>r.hasNext.value),hasPrevious:f(()=>r.hasPrevious.value),qTablePagination:r.qTablePagination,fetchMeasurementSystems:g,fetchMeasurementSystemById:p,createMeasurementSystem:h,updateMeasurementSystem:T,deleteMeasurementSystem:I,clearSelectedMeasurementSystem:E,searchMeasurementSystems:_,filterMeasurementSystems:D,clearFilters:M,patchMeasurementSystemStatus:P,bulkDeleteMeasurementSystems:$,bulkUpdateMeasurementSystemStatus:w,goToPage:r.goToPage,goToNextPage:r.goToNextPage,goToPreviousPage:r.goToPreviousPage,handleTableRequest:r.handleTableRequest}});export{O as u};
