import{defineComponent as L,resolveComponent as x,useSSRContext as C,ref as _,computed as R,onMounted as M,getCurrentInstance as U,h as j,markRaw as O,createApp as Q,unref as H}from"vue";import{Notify as f,Quasar as N,Dialog as D,Loading as F}from"quasar";import{ssrRenderComponent as W}from"vue/server-renderer";import{createPinia as G,defineStore as J}from"pinia";import{boot as K,route as V}from"quasar/wrappers";import{createRouter as X,createMemoryHistory as Y}from"vue-router";import B from"axios";const k=L({__name:"App",__ssrInlineRender:!0,setup(e){return(t,o,r,i)=>{const s=x("router-view");o(W(s,i,null,r))}}}),I=k.setup;k.setup=(e,t)=>{const o=C();return(o.modules||(o.modules=new Set)).add("src/App.vue"),I?I(e,t):void 0};const Z=e=>e,ee=Z,w=ee(()=>G()),P=[{path:"/dashboard",component:()=>import("./assets/UserLayout-c0ZUReTN.js"),children:[{path:"",name:"Dashboard",component:()=>import("./assets/IndexPage-DbN3ZWvX.js"),meta:{title:"Главная",icon:"dashboard",requiresAuth:!0}}]},{path:"/brands",component:()=>import("./assets/UserLayout-c0ZUReTN.js"),children:[{path:"",name:"Brands",component:()=>import("./assets/BrandsPage-C9B4BQ63.js"),meta:{title:"Бренды",icon:"branding_watermark",requiresAuth:!0}}]},{path:"/measurement-systems",component:()=>import("./assets/UserLayout-c0ZUReTN.js"),children:[{path:"",name:"MeasurementSystems",component:()=>import("./assets/MeasurementSystemPage-x2aC1stG.js"),meta:{title:"Системы измерений",icon:"straighten",requiresAuth:!0}}]},{path:"/product-types",component:()=>import("./assets/UserLayout-c0ZUReTN.js"),children:[{path:"",name:"ProductTypes",component:()=>import("./assets/ProductTypesPage-DKuhFPNF.js"),meta:{title:"Типы товаров",icon:"category",requiresAuth:!0}}]},{path:"/size-charts",component:()=>import("./assets/UserLayout-c0ZUReTN.js"),children:[{path:"",name:"SizeCharts",component:()=>import("./assets/SizeChartsPage-DHgEv6Hv.js"),meta:{title:"Размерные сетки",icon:"grid_on",requiresAuth:!0}}]},{path:"/sizes",component:()=>import("./assets/UserLayout-c0ZUReTN.js"),children:[{path:"",name:"Sizes",component:()=>import("./assets/SizesPage-CuyXS7bY.js"),meta:{title:"Размеры",icon:"photo_size_select_small",requiresAuth:!0}}]},{path:"/service-categories",component:()=>import("./assets/UserLayout-c0ZUReTN.js"),children:[{path:"",name:"ServiceCategories",component:()=>import("./assets/ServiceCategoriesPage-jz3MeBIH.js"),meta:{title:"Категории услуг",icon:"category",requiresAuth:!0}}]}],q=[{path:"/",component:()=>import("./assets/GuestLayout-D0OBJecT.js"),children:[{path:"",component:()=>import("./assets/IndexPage-DbN3ZWvX.js")},{path:"/login",component:()=>import("./assets/LoginAuthPage-D__tR2D_.js")},{path:"/register",component:()=>import("./assets/RegisterPage-BoewYEfm.js")}]}],te="https://app-kit.ru/api/v1",l=B.create({baseURL:te,headers:{"Content-Type":"application/json"}});let A=!1,b=[];const $=(e,t=null)=>{b.forEach(o=>{e?o.reject(e):t&&o.resolve(t)}),b=[]},oe=K(async({app:e,router:t,store:o})=>{const r=E(o),i=localStorage.getItem("accessToken");if(i&&(l.defaults.headers.common.Authorization=`Bearer ${i}`,console.log("axios boot: Bearer token set from localStorage.")),r.isLoggedIn){console.log("axios boot: Пользователь авторизован, загружаем профиль...");try{await r.fetchProfile(),console.log("axios boot: Профиль успешно загружен.")}catch(s){console.error("axios boot: Ошибка при начальной загрузке профиля.",s)}}else console.log("axios boot: Токен не найден, пропускаем загрузку профиля.");l.interceptors.response.use(s=>s,async s=>{const n=s.config;if(s.response?.status===401&&n&&!n._retry){if(n.url?.includes("/auth-tokens/refresh/"))return console.error("Refresh токен невалиден или просрочен. Выход из системы."),await r.logout(t),Promise.reject(s);if(A)return new Promise((u,p)=>{b.push({resolve:u,reject:p})}).then(u=>(n.headers&&(n.headers.Authorization=`Bearer ${u}`),l(n)));n._retry=!0,A=!0;try{return await r.refreshAccessToken()&&r.accessToken?($(null,r.accessToken),n.headers&&(n.headers.Authorization=`Bearer ${r.accessToken}`),l(n)):($(s,null),await r.logout(t),Promise.reject(s))}finally{A=!1}}return Promise.reject(s)}),e.config.globalProperties.$axios=B,e.config.globalProperties.$api=l}),re=Object.freeze(Object.defineProperty({__proto__:null,api:l,default:oe},Symbol.toStringTag,{value:"Module"})),E=J("user",()=>{const e=_(localStorage.getItem("accessToken")),t=_(localStorage.getItem("refreshToken")),o=_(null),r=_(!1),i=R(()=>!!e.value),s=R(()=>o.value?.role==="Admin");function n(a,h){a?(localStorage.setItem("accessToken",a),l.defaults.headers.common.Authorization=`Bearer ${a}`,e.value=a):(localStorage.removeItem("accessToken"),delete l.defaults.headers.common.Authorization,e.value=null),h?(localStorage.setItem("refreshToken",h),t.value=h):h===null&&(localStorage.removeItem("refreshToken"),t.value=null)}async function u(a){n(null,null),o.value=null,f.create({type:"info",message:"Вы вышли из системы."}),await a.push({path:"/login"})}async function p(){if(i.value){r.value=!0;try{const{data:a}=await l.get("/users/me/");o.value=a}catch(a){console.error("Failed to fetch user profile:",a),f.create({type:"negative",message:"Не удалось загрузить профиль пользователя."})}finally{r.value=!1}}}async function m(a,h){r.value=!0;try{const d=await l.post("/auth-tokens",a);n(d.data.access,d.data.refresh),await p(),f.create({type:"positive",message:`Добро пожаловать, ${o.value?.email||""}!`}),await h.push({path:"/dashboard"})}catch(d){const g=d;console.error("Login failed:",g);let y="Неизвестная ошибка авторизации";const v=g.response?.data;v?.detail?y=v.detail:v?.message?y=v.message:g.message&&(y=g.message),f.create({type:"negative",message:y})}finally{r.value=!1}}async function c(){if(!t.value)return!1;try{const a=await l.post("/auth-tokens/refresh/",{refresh:t.value});return n(a.data.access),console.log("Access token has been refreshed."),!0}catch(a){return console.error("Failed to refresh token:",a),!1}}return{accessToken:e,refreshToken:t,profile:o,loading:r,isLoggedIn:i,isAdmin:s,login:m,logout:u,fetchProfile:p,setTokens:n,refreshAccessToken:c}}),ne=[{path:"/:catchAll(.*)*",component:()=>import("./assets/ErrorNotFound-2tt_H2MZ.js")}],T=V(function({store:e}){const t=Y,o=X({scrollBehavior:()=>({left:0,top:0}),routes:[...ne,...q,...P],history:t(void 0)});return o.beforeEach(async(r,i,s)=>{const n=E(e);n.accessToken&&!n.profile&&await n.fetchProfile();const u=P.some(m=>r.path.startsWith(m.path)),p=q.some(m=>m.children?.some(c=>c.path===r.path||m.path===r.path&&c.path===""));u&&!n.isLoggedIn?s({path:"/login"}):p&&n.isLoggedIn&&r.path!=="/"?s({path:"/dashboard"}):s()}),o}),se=L({name:"AppWrapper",setup(e){return M(()=>{const{proxy:{$q:t}}=U();t.onSSRHydrated!==void 0&&t.onSSRHydrated()}),()=>j(k,e)}});async function ae(e,t,o){const r=e(se);r.use(N,t,o);const i=typeof w=="function"?await w({ssrContext:o}):w;r.use(i),typeof window<"u"&&window.__INITIAL_STATE__!==void 0&&(i.state.value=window.__INITIAL_STATE__,delete window.__INITIAL_STATE__);const s=O(typeof T=="function"?await T({ssrContext:o,store:i}):T);return i.use(({store:n})=>{n.router=s}),{app:r,store:i,router:s}}const ie={config:{},plugins:{Notify:f,Loading:F,Dialog:D}},ce="/",le=/^https?:\/\//;function ue(e,t){if(typeof e=="string"&&le.test(e)===!0)return e;try{return t.resolve(e).href}catch{}return e}const{components:_e,directives:Se,...pe}=ie;let S=null,z=Promise.allSettled([Promise.resolve().then(()=>re),import("./assets/quasar-lang-DFoVxELm.js")]).then(e=>e.map(t=>{if(t.status==="rejected"){console.error("[Quasar] boot error:",t.reason);return}return t.value.default})).then(e=>e.filter(t=>typeof t=="function"));const we=e=>new Promise(async(t,o)=>{S===null&&(S=await z,z=null);const{app:r,router:i,store:s}=await ae(Q,pe,e);let n=!1;const u=(c,a)=>{n=!0,o({url:ue(c,i),code:a})};for(let c=0;n===!1&&c<S.length;c++)try{await S[c]({app:r,router:i,store:s,ssrContext:e,redirect:u,urlPath:e.req.url,publicPath:ce})}catch(a){o(a);return}if(n===!0)return;r.use(i);const p=e.req.url,{fullPath:m}=i.resolve(p);if(m!==p)return o({url:m});i.push(p).catch(()=>{}),i.isReady().then(()=>{if(i.currentRoute.value.matched.filter(a=>a.components!==void 0).flatMap(a=>Object.values(a.components)).length===0)return o({code:404});e.state=H(s.state),t(r)}).catch(o)});export{l as a,we as default,E as u};
